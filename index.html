<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ally Heev â€” Open Source Portfolio</title>

  <!-- Styles -->
  <link rel="stylesheet" href="assets/style.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="title">
        <h1>Ally Heev <span class="muted">/ @aheev</span></h1>
        <p class="subtitle">Open-source contributions â€” Apache Kafka Â· Apache Iceberg Â· Linux kernel</p>
      </div>
      <div class="controls">
        <button id="theme-toggle" title="Toggle theme">ðŸŒ™</button>
      </div>
    </div>
  </header>

  <main class="wrapper">
    <nav class="filters" aria-label="filters">
      <button class="filter active" data-filter="all">All</button>
      <button class="filter" data-filter="github">GitHub</button>
      <button class="filter" data-filter="jira">Kafka JIRA</button>
      <button class="filter" data-filter="kernel">Kernel (lore)</button>
      <button class="filter" data-filter="gitkernel">git.kernel.org</button>
    </nav>

    <section class="overview">
      <div class="card stats">
        <div class="stats-left">
          <div class="big" id="big-merged">â€”</div>
          <div class="muted">merged PRs</div>
        </div>
        <div class="stats-right">
          <div class="stat-item"><strong id="count-prs">â€”</strong><div class="muted">total PRs</div></div>
          <div class="stat-item"><strong id="count-jira">â€”</strong><div class="muted">Kafka tickets</div></div>
          <div class="stat-item"><strong id="count-linux">â€”</strong><div class="muted">kernel patches</div></div>
        </div>
      </div>

      <div class="card small quick">
        <h3>Quick counts</h3>
        <ul id="quick-list" class="compact">
          <li>GitHub PRs: â€”</li>
          <li>Kafka JIRA: â€”</li>
          <li>Kernel patches: â€”</li>
          <li>git.kernel.org commits: â€”</li>
        </ul>
      </div>
    </section>

    <section class="analytics">
      <h2>Analytics & Timelines</h2>

      <div class="grid">
        <div class="card">
          <h4>Monthly timeline</h4>
          <canvas id="timelineChart" aria-label="Timeline chart" role="img"></canvas>
        </div>

        <div class="card">
          <h4>Kernel subsystems</h4>
          <canvas id="subsystemChart" aria-label="Subsystem chart" role="img"></canvas>
        </div>

        <div class="card">
          <h4>Top repos (PRs)</h4>
          <canvas id="reposChart" aria-label="Top repos chart" role="img"></canvas>
        </div>
      </div>
    </section>

    <section class="latest">
      <h2>Latest contributions</h2>
      <div id="latest-list">Loadingâ€¦</div>
    </section>

    <footer class="footer">
      <p>Data generated from GitHub, Apache JIRA, lore.kernel.org and git.kernel.org. Site auto-updated via GitHub Actions.</p>
    </footer>
  </main>

<script>
/* Page logic: loads JSON files and populates page & charts */
async function loadJSON(path){
  try {
    const res = await fetch(path, {cache: 'no-store'});
    return res.ok ? await res.json() : null;
  } catch (e) { return null; }
}

/* Render page content */
async function renderPage(){
  const [gh, jira, linux, gitk, analytics] = await Promise.all([
    loadJSON('data/github.json'),
    loadJSON('data/kafka_jira.json'),
    loadJSON('data/linux_patches.json'),
    loadJSON('data/gitkernel.json'),
    loadJSON('data/analytics.json')
  ]);

  // Quick stats
  const totalPRs = gh?.items?.length || 0;
  const mergedPRs = gh?.mergedCount || 0;
  const jiraTotal = jira?.total || 0;
  const linuxPatches = linux?.count || 0;
  const gitkCount = gitk?.count || 0;

  document.getElementById('big-merged').textContent = mergedPRs;
  document.getElementById('count-prs').textContent = totalPRs;
  document.getElementById('count-jira').textContent = jiraTotal;
  document.getElementById('count-linux').textContent = linuxPatches;

  const quickList = document.getElementById('quick-list');
  quickList.innerHTML = `
    <li>GitHub PRs: <strong>${totalPRs}</strong></li>
    <li>GitHub merged: <strong>${mergedPRs}</strong></li>
    <li>Kafka JIRA: <strong>${jiraTotal}</strong></li>
    <li>Kernel patches (lore): <strong>${linuxPatches}</strong></li>
    <li>git.kernel.org commits: <strong>${gitkCount}</strong></li>
  `;

  // Latest list
  const latest = [];
  if (gh?.items) latest.push(...gh.items.map(i=>({type:'GitHub', title:i.title, link:i.url, date:i.mergedAt || i.updatedAt})));
  if (jira?.items) latest.push(...jira.items.map(i=>({type:'JIRA', title:i.key + ': ' + i.fields.summary, link:'https://issues.apache.org/jira/browse/' + i.key, date:i.fields.updated})));
  if (linux?.items) latest.push(...linux.items.map(i=>({type:'Kernel', title:i.subject || i.title || '(patch)', link:i.url || i.link, date:i.date})));
  if (gitk?.items) latest.push(...gitk.items.map(i=>({type:'git.kernel', title:i.title, link:i.url, date:i.date})));

  latest.sort((a,b)=> new Date(b.date) - new Date(a.date));
  const latestEl = document.getElementById('latest-list');
  if (latest.length === 0) {
    latestEl.innerHTML = '<p>No contributions found yet.</p>';
  } else {
    latestEl.innerHTML = '<ul class="list">' + latest.slice(0,30).map(x=>`
      <li class="list-item">
        <span class="pill">${x.type}</span>
        <a href="${x.link}" target="_blank" rel="noopener noreferrer">${x.title}</a>
        <span class="muted"> â€” ${new Date(x.date).toLocaleDateString()}</span>
      </li>`).join('') + '</ul>';
  }

  // Init charts if analytics available
  if (typeof window.initCharts === 'function' && analytics) {
    window.initCharts(analytics);
  } else if (analytics) {
    // fallback: attempt to load charts script later if not loaded
    setTimeout(()=>{ if (typeof window.initCharts === 'function') window.initCharts(analytics); }, 500);
  }
}

renderPage();

/* Theme toggle */
const themeToggle = document.getElementById('theme-toggle');
const root = document.documentElement;
const saved = localStorage.getItem('theme');
if (saved) root.setAttribute('data-theme', saved);
themeToggle.addEventListener('click', ()=>{
  const cur = root.getAttribute('data-theme') || 'dark';
  const next = cur === 'dark' ? 'light' : 'dark';
  root.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  themeToggle.textContent = next === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
});

/* Simple filter behavior */
document.querySelectorAll('.filter').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.filter').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const f = b.getAttribute('data-filter');
    document.querySelectorAll('.pill').forEach(p=>{
      const li = p.parentElement;
      if (f === 'all') li.style.display = '';
      else li.style.display = p.textContent.toLowerCase().includes(f) ? '' : 'none';
    });
  });
});
</script>

<script src="assets/charts.js"></script>
</body>
</html>
