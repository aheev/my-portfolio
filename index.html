<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ally Heev â€” Open Source Portfolio</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="inner">
      <div>
        <h1>Ally Heev <span class="muted">/ @aheev</span></h1>
        <p class="muted small">Open-source contributions â€” Apache Kafka Â· Apache Iceberg Â· Linux kernel</p>
      </div>
      <div>
        <button id="theme-toggle" title="Toggle theme">ğŸŒ™</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="cards">
      <div class="card">
        <div class="big" id="merged-count">â€”</div>
        <div class="muted">merged PRs</div>
      </div>
      <div class="card small">
        <div>GitHub PRs: <strong id="pr-count">â€”</strong></div>
        <div>Kafka JIRA: <strong id="jira-count">â€”</strong></div>
        <div>Kernel patches: <strong id="patch-count">â€”</strong></div>
      </div>
    </section>

    <section>
      <h2>Timeline (monthly)</h2>
      <canvas id="timelineChart" height="120"></canvas>
    </section>

    <section class="grid">
      <div class="card">
        <h3>Kernel subsystems</h3>
        <canvas id="subsystemChart" height="160"></canvas>
      </div>
      <div class="card">
        <h3>Top repos (PRs)</h3>
        <canvas id="reposChart" height="160"></canvas>
      </div>
    </section>

    <section>
      <h2>Latest contributions</h2>
      <div id="latest">Loadingâ€¦</div>
    </section>

    <footer class="footer muted">Site auto-updated via GitHub Actions</footer>
  </main>

<script>
async function loadJSON(path){
  try { const r = await fetch(path, {cache: 'no-store'}); return r.ok ? await r.json() : null }
  catch(e){ return null }
}

async function init(){
  const [gh, jira, commits, patches, analytics] = await Promise.all([
    loadJSON('data/github.json'),
    loadJSON('data/kafka_jira.json'),
    loadJSON('data/linux_commits.json'),
    loadJSON('data/linux_patches.json'),
    loadJSON('data/analytics.json'),
  ]);

  document.getElementById('merged-count').textContent = gh?.mergedCount || 0;
  document.getElementById('pr-count').textContent = (gh?.items?.length || 0);
  document.getElementById('jira-count').textContent = (jira?.total || 0);
  document.getElementById('patch-count').textContent = (patches?.patches?.length || 0);

  // latest list
  const latest = [];
  if (gh?.items) latest.push(...gh.items.map(i=>({t:'GitHub', title:i.title, url:i.url, date:i.mergedAt||i.updatedAt})));
  if (jira?.items) latest.push(...jira.items.map(i=>({t:'JIRA', title:i.key+': '+i.fields.summary, url:'https://issues.apache.org/jira/browse/'+i.key, date:i.fields.updated})));
  if (commits?.commits) latest.push(...commits.commits.map(i=>({t:'Kernel commit', title:i.title, url:i.url, date:i.date})));
  if (patches?.patches) latest.push(...patches.patches.map(i=>({t:'Kernel patch', title:i.title, url:i.url, date:i.date})));
  latest.sort((a,b)=> new Date(b.date) - new Date(a.date));
  const latestEl = document.getElementById('latest');
  latestEl.innerHTML = '<ul>' + latest.slice(0,20).map(x=>`<li><strong>${x.t}</strong> â€” <a href="${x.url}" target="_blank">${x.title}</a> <span class="muted">(${new Date(x.date).toLocaleDateString()})</span></li>`).join('') + '</ul>';

  // charts
  if (analytics && window.renderCharts) window.renderCharts(analytics);
}
init();

/* theme */
const tbtn = document.getElementById('theme-toggle');
const root = document.documentElement;
if(localStorage.getItem('theme')==='light') root.setAttribute('data-theme','light');
tbtn.addEventListener('click', ()=>{
  const cur = root.getAttribute('data-theme') || 'dark';
  const next = cur === 'dark' ? 'light' : 'dark';
  root.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  tbtn.textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
});
</script>

<script src="assets/charts.js"></script>
</body>
</html>
